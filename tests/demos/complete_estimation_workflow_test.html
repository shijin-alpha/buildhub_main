<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Estimation Workflow Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 32px;
        }
        .header p {
            color: #7f8c8d;
            margin: 10px 0 0 0;
            font-size: 16px;
        }
        .workflow-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .step {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }
        .step.active {
            border-color: #007bff;
            background: #e7f3ff;
        }
        .step.completed {
            border-color: #28a745;
            background: #d4edda;
        }
        .step.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .step-number {
            position: absolute;
            top: -10px;
            left: 20px;
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .step.completed .step-number {
            background: #28a745;
        }
        .step.error .step-number {
            background: #dc3545;
        }
        .step h3 {
            margin: 10px 0 15px 0;
            color: #2c3e50;
        }
        .step p {
            color: #6c757d;
            margin: 0 0 15px 0;
            line-height: 1.5;
        }
        .step-button {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 10px;
        }
        .step-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .step-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .step-results {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
        .warning { color: #ffc107; }
        .estimate-display {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .estimate-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .estimate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .estimate-title {
            font-weight: bold;
            color: #2c3e50;
        }
        .estimate-total {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
        }
        .estimate-details {
            color: #6c757d;
            font-size: 14px;
            margin: 5px 0;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            background: #e3f2fd;
            color: #1976d2;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
        .summary {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 8px;
            text-align: center;
        }
        .summary h3 {
            margin: 0 0 10px 0;
        }
        .summary p {
            margin: 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è Complete Estimation Workflow Test</h1>
            <p>Testing the complete flow from inbox form submission to My Estimates display</p>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <div class="workflow-steps">
            <div class="step" id="step-1">
                <div class="step-number">1</div>
                <h3>üì§ Submit Estimate via Inbox Form</h3>
                <p>Simulate submitting an estimate through the contractor inbox form using the submit_estimate_for_send.php API</p>
                <button class="step-button" onclick="submitEstimate()">Submit Test Estimate</button>
                <div class="step-results" id="step-1-results"></div>
            </div>

            <div class="step" id="step-2">
                <div class="step-number">2</div>
                <h3>üì• Fetch My Estimates</h3>
                <p>Retrieve all estimates for the contractor using the get_my_estimates.php API</p>
                <button class="step-button" onclick="fetchEstimates()" disabled>Fetch Estimates</button>
                <div class="step-results" id="step-2-results"></div>
            </div>

            <div class="step" id="step-3">
                <div class="step-number">3</div>
                <h3>üé® Display Estimates</h3>
                <p>Display the estimates in the same format as the ContractorDashboard EstimateListItem component</p>
                <button class="step-button" onclick="displayEstimates()" disabled>Display Estimates</button>
                <div class="step-results" id="step-3-results"></div>
            </div>

            <div class="step" id="step-4">
                <div class="step-number">4</div>
                <h3>‚úÖ Verify Data Structure</h3>
                <p>Verify that the data structure is compatible with the frontend component</p>
                <button class="step-button" onclick="verifyDataStructure()" disabled>Verify Structure</button>
                <div class="step-results" id="step-4-results"></div>
            </div>
        </div>

        <div class="estimate-display" id="estimate-display" style="display: none;">
            <h3>üìä My Estimates Display</h3>
            <div id="estimates-container"></div>
        </div>

        <div class="summary" id="summary" style="display: none;">
            <h3>üéâ Workflow Complete!</h3>
            <p>All steps completed successfully. Submitted estimates are now visible in the My Estimates section.</p>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let totalSteps = 4;
        let workflowData = {
            submittedEstimateId: null,
            fetchedEstimates: [],
            verificationResults: {}
        };

        function updateProgress() {
            const progressFill = document.getElementById('progress-fill');
            const percentage = ((currentStep - 1) / totalSteps) * 100;
            progressFill.style.width = percentage + '%';
        }

        function setStepStatus(stepNumber, status) {
            const step = document.getElementById(`step-${stepNumber}`);
            step.className = `step ${status}`;
            
            if (status === 'completed' && stepNumber < totalSteps) {
                const nextButton = document.querySelector(`#step-${stepNumber + 1} .step-button`);
                nextButton.disabled = false;
            }
        }

        function log(stepNumber, message, type = 'info') {
            const resultsDiv = document.getElementById(`step-${stepNumber}-results`);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const logEntry = `<div class="${className}">[${timestamp}] ${message}</div>`;
            resultsDiv.innerHTML += logEntry;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            console.log(`[Step ${stepNumber}] ${message}`);
        }

        async function submitEstimate() {
            setStepStatus(1, 'active');
            log(1, 'Starting estimate submission...', 'info');

            try {
                const testData = {
                    contractor_id: 1,
                    send_id: 1,
                    structured: {
                        project_name: 'Modern Villa Construction',
                        project_address: '456 Premium Street, Luxury City',
                        client_name: 'Premium Homeowner',
                        client_contact: 'premium@example.com',
                        plot_size: '3000 sq.ft',
                        built_up_area: '2200 sq.ft',
                        floors: '2',
                        estimation_date: new Date().toISOString().split('T')[0],
                        materials: {
                            cement: { name: 'Premium Cement (OPC 53 Grade)', qty: '75', rate: '450', amount: '33750' },
                            sand: { name: 'River Sand (Premium)', qty: '8', rate: '2200', amount: '17600' },
                            bricks: { name: 'Clay Bricks (Premium)', qty: '3000', rate: '10', amount: '30000' },
                            steel: { name: 'TMT Steel Bars', qty: '2', rate: '55000', amount: '110000' },
                            aggregate: { name: '20mm Aggregate', qty: '10', rate: '1800', amount: '18000' }
                        },
                        labor: {
                            masonry: { name: 'Expert Masonry Work', qty: '1', rate: '25000', amount: '25000' },
                            plumbing: { name: 'Premium Plumbing', qty: '1', rate: '18000', amount: '18000' },
                            electrical: { name: 'Electrical Installation', qty: '1', rate: '15000', amount: '15000' },
                            painting: { name: 'Premium Painting', qty: '1', rate: '12000', amount: '12000' },
                            flooring: { name: 'Tile Flooring', qty: '1', rate: '20000', amount: '20000' }
                        },
                        utilities: {
                            sanitary: { name: 'Premium Sanitary Fixtures', qty: '1', rate: '15000', amount: '15000' },
                            kitchen: { name: 'Modular Kitchen Setup', qty: '1', rate: '25000', amount: '25000' },
                            electrical_fixtures: { name: 'Electrical Fixtures', qty: '1', rate: '12000', amount: '12000' }
                        },
                        misc: {
                            transport: { name: 'Material Transportation', qty: '1', rate: '8000', amount: '8000' },
                            contingency: { name: 'Contingency (5%)', qty: '1', rate: '18000', amount: '18000' },
                            fees: { name: 'Approval Fees', qty: '1', rate: '5000', amount: '5000' }
                        },
                        totals: {
                            materials: 209350,
                            labor: 90000,
                            utilities: 52000,
                            misc: 31000,
                            grand: 382350
                        }
                    },
                    timeline: '120 days',
                    total_cost: 382350,
                    notes: 'Premium construction with high-quality materials and expert craftsmanship. Includes modern amenities and fixtures.'
                };

                log(1, 'Sending request to submit_estimate_for_send.php...', 'info');

                const response = await fetch('/buildhub/backend/api/contractor/submit_estimate_for_send.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(testData)
                });

                const result = await response.json();

                if (result.success) {
                    workflowData.submittedEstimateId = result.estimate_id;
                    log(1, `‚úÖ Estimate submitted successfully!`, 'success');
                    log(1, `üìã Estimate ID: ${result.estimate_id}`, 'info');
                    log(1, `üè† Project: ${result.data.project_name}`, 'info');
                    log(1, `üí∞ Total Cost: ‚Çπ${result.data.total_cost?.toLocaleString('en-IN')}`, 'info');
                    log(1, `‚è±Ô∏è Timeline: ${testData.timeline}`, 'info');
                    
                    setStepStatus(1, 'completed');
                    currentStep = 2;
                    updateProgress();
                } else {
                    log(1, `‚ùå Submission failed: ${result.message}`, 'error');
                    setStepStatus(1, 'error');
                }

            } catch (error) {
                log(1, `‚ùå Network error: ${error.message}`, 'error');
                setStepStatus(1, 'error');
            }
        }

        async function fetchEstimates() {
            setStepStatus(2, 'active');
            log(2, 'Fetching contractor estimates...', 'info');

            try {
                const contractorId = 1;
                const response = await fetch(`/buildhub/backend/api/contractor/get_my_estimates.php?contractor_id=${contractorId}`, {
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    workflowData.fetchedEstimates = result.estimates;
                    log(2, `‚úÖ Successfully fetched ${result.count} estimates`, 'success');
                    
                    result.estimates.forEach((estimate, index) => {
                        log(2, `üìÑ Estimate #${estimate.id}: ${estimate.project_name} - ‚Çπ${estimate.total_cost?.toLocaleString('en-IN')}`, 'info');
                    });

                    // Check if our submitted estimate is in the list
                    const submittedEstimate = result.estimates.find(est => est.id == workflowData.submittedEstimateId);
                    if (submittedEstimate) {
                        log(2, `‚úÖ Submitted estimate #${workflowData.submittedEstimateId} found in results!`, 'success');
                    } else {
                        log(2, `‚ö†Ô∏è Submitted estimate #${workflowData.submittedEstimateId} not found in results`, 'warning');
                    }

                    setStepStatus(2, 'completed');
                    currentStep = 3;
                    updateProgress();
                } else {
                    log(2, `‚ùå Failed to fetch estimates: ${result.message}`, 'error');
                    setStepStatus(2, 'error');
                }

            } catch (error) {
                log(2, `‚ùå Network error: ${error.message}`, 'error');
                setStepStatus(2, 'error');
            }
        }

        function displayEstimates() {
            setStepStatus(3, 'active');
            log(3, 'Displaying estimates in UI format...', 'info');

            try {
                const displayDiv = document.getElementById('estimate-display');
                const container = document.getElementById('estimates-container');

                if (workflowData.fetchedEstimates.length === 0) {
                    log(3, '‚ùå No estimates to display', 'error');
                    setStepStatus(3, 'error');
                    return;
                }

                let html = '';
                
                workflowData.fetchedEstimates.forEach(estimate => {
                    const createdDate = new Date(estimate.created_at).toLocaleDateString('en-IN');
                    const isNewlySubmitted = estimate.id == workflowData.submittedEstimateId;
                    
                    html += `
                        <div class="estimate-card" style="${isNewlySubmitted ? 'border-left: 4px solid #28a745; background: linear-gradient(to right, #ffffff 0%, #f0fff4 5%);' : ''}">
                            <div class="estimate-header">
                                <div class="estimate-title">
                                    ${isNewlySubmitted ? 'üÜï ' : 'üìÑ '}Estimate #${estimate.id}
                                    <span class="status-badge">${estimate.status.toUpperCase()}</span>
                                </div>
                                <div class="estimate-total">‚Çπ${estimate.total_cost?.toLocaleString('en-IN')}</div>
                            </div>
                            <div class="estimate-details">
                                <strong>Project:</strong> ${estimate.project_name || 'Untitled Project'}
                            </div>
                            <div class="estimate-details">
                                <strong>Client:</strong> ${estimate.client_name || 'Unknown Client'}
                            </div>
                            <div class="estimate-details">
                                <strong>Location:</strong> ${estimate.location || 'Not specified'}
                            </div>
                            <div class="estimate-details">
                                <strong>Timeline:</strong> ${estimate.timeline || 'Not specified'}
                            </div>
                            <div class="estimate-details">
                                <strong>Created:</strong> ${createdDate}
                            </div>
                            ${estimate.notes ? `<div class="estimate-details"><strong>Notes:</strong> ${estimate.notes}</div>` : ''}
                            ${isNewlySubmitted ? '<div class="estimate-details" style="color: #28a745; font-weight: bold;">‚úÖ This is the estimate we just submitted!</div>' : ''}
                        </div>
                    `;
                });

                container.innerHTML = html;
                displayDiv.style.display = 'block';

                log(3, `‚úÖ Successfully displayed ${workflowData.fetchedEstimates.length} estimates`, 'success');
                log(3, 'üé® Estimates are now visible in the UI format', 'info');

                setStepStatus(3, 'completed');
                currentStep = 4;
                updateProgress();

            } catch (error) {
                log(3, `‚ùå Display error: ${error.message}`, 'error');
                setStepStatus(3, 'error');
            }
        }

        function verifyDataStructure() {
            setStepStatus(4, 'active');
            log(4, 'Verifying data structure compatibility...', 'info');

            try {
                if (workflowData.fetchedEstimates.length === 0) {
                    log(4, '‚ùå No estimates to verify', 'error');
                    setStepStatus(4, 'error');
                    return;
                }

                const testEstimate = workflowData.fetchedEstimates.find(est => est.id == workflowData.submittedEstimateId);
                
                if (!testEstimate) {
                    log(4, '‚ùå Submitted estimate not found for verification', 'error');
                    setStepStatus(4, 'error');
                    return;
                }

                // Verify required fields
                const requiredFields = ['id', 'project_name', 'client_name', 'total_cost', 'status', 'created_at'];
                const missingFields = requiredFields.filter(field => !testEstimate[field]);
                
                if (missingFields.length > 0) {
                    log(4, `‚ùå Missing required fields: ${missingFields.join(', ')}`, 'error');
                    setStepStatus(4, 'error');
                    return;
                }

                log(4, '‚úÖ All required fields present', 'success');

                // Verify structured data
                if (testEstimate.structured_data) {
                    try {
                        const structuredData = JSON.parse(testEstimate.structured_data);
                        log(4, '‚úÖ Structured data is valid JSON', 'success');
                        
                        if (structuredData.totals && structuredData.totals.grand) {
                            log(4, `‚úÖ Grand total in structured data: ‚Çπ${structuredData.totals.grand.toLocaleString('en-IN')}`, 'success');
                        }
                        
                        if (structuredData.materials && Object.keys(structuredData.materials).length > 0) {
                            log(4, `‚úÖ Materials data contains ${Object.keys(structuredData.materials).length} items`, 'success');
                        }
                        
                        if (structuredData.labor && Object.keys(structuredData.labor).length > 0) {
                            log(4, `‚úÖ Labor data contains ${Object.keys(structuredData.labor).length} items`, 'success');
                        }

                    } catch (parseError) {
                        log(4, `‚ùå Structured data parsing error: ${parseError.message}`, 'error');
                        setStepStatus(4, 'error');
                        return;
                    }
                } else {
                    log(4, '‚ö†Ô∏è No structured data found', 'warning');
                }

                // Verify EstimateListItem compatibility
                log(4, 'üîç Testing EstimateListItem component compatibility...', 'info');
                
                // Simulate the money function from EstimateListItem
                const money = (v) => {
                    const n = parseFloat(v);
                    if (Number.isFinite(n)) return `‚Çπ${n.toLocaleString('en-IN')}`;
                    return '‚Äî';
                };

                const displayTotal = money(testEstimate.total_cost);
                const displayDate = new Date(testEstimate.created_at).toLocaleString();
                
                log(4, `‚úÖ Money formatting works: ${displayTotal}`, 'success');
                log(4, `‚úÖ Date formatting works: ${displayDate}`, 'success');
                log(4, `‚úÖ Status display: ${testEstimate.status}`, 'success');

                workflowData.verificationResults = {
                    hasRequiredFields: true,
                    hasValidStructuredData: !!testEstimate.structured_data,
                    isCompatibleWithComponent: true,
                    estimateId: testEstimate.id,
                    totalCost: testEstimate.total_cost
                };

                log(4, 'üéâ All verification checks passed!', 'success');
                log(4, '‚úÖ Data structure is fully compatible with EstimateListItem component', 'success');

                setStepStatus(4, 'completed');
                currentStep = 5;
                updateProgress();

                // Show summary
                document.getElementById('summary').style.display = 'block';

            } catch (error) {
                log(4, `‚ùå Verification error: ${error.message}`, 'error');
                setStepStatus(4, 'error');
            }
        }

        // Initialize
        updateProgress();
    </script>
</body>
</html>