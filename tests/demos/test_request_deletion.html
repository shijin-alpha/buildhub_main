<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Request Deletion</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { margin: 5px; padding: 8px 15px; }
        .request-card { border: 1px solid #ccc; margin: 10px 0; padding: 10px; }
    </style>
</head>
<body>
    <h1>Test Request Deletion</h1>
    <p>This test simulates the homeowner request deletion process.</p>

    <div class="test-section">
        <h3>Step 1: Create Test Request</h3>
        <button onclick="createTestRequest()">Create Test Request</button>
        <div id="create-results"></div>
    </div>

    <div class="test-section">
        <h3>Step 2: List Current Requests</h3>
        <button onclick="listRequests()">List My Requests</button>
        <div id="list-results"></div>
    </div>

    <div class="test-section">
        <h3>Step 3: Delete Request</h3>
        <input type="number" id="deleteRequestId" placeholder="Request ID to delete">
        <button onclick="deleteRequest()">Delete Request</button>
        <div id="delete-results"></div>
    </div>

    <div class="test-section">
        <h3>Step 4: Verify Deletion</h3>
        <button onclick="verifyDeletion()">Check Architect View</button>
        <div id="verify-results"></div>
    </div>

    <script>
        let testRequestId = null;

        async function createTestRequest() {
            const resultsDiv = document.getElementById('create-results');
            
            try {
                resultsDiv.innerHTML = '<p class="info">Creating test request...</p>';
                
                const response = await fetch('/buildhub/backend/api/homeowner/submit_request.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        plot_size: '30x40',
                        budget_range: '20-30 lakhs',
                        requirements: 'Test request for deletion testing',
                        location: 'Test City',
                        timeline: '6-12 months'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    testRequestId = data.request_id;
                    resultsDiv.innerHTML = `<p class="success">✓ Test request created with ID: ${testRequestId}</p>`;
                    document.getElementById('deleteRequestId').value = testRequestId;
                } else {
                    resultsDiv.innerHTML = `<p class="error">✗ Failed to create request: ${data.message}</p>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">✗ Network error: ${error.message}</p>`;
            }
        }

        async function listRequests() {
            const resultsDiv = document.getElementById('list-results');
            
            try {
                resultsDiv.innerHTML = '<p class="info">Loading requests...</p>';
                
                const response = await fetch('/buildhub/backend/api/homeowner/get_layout_requests.php', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const requests = data.requests || [];
                    const activeRequests = requests.filter(r => r.status !== 'deleted');
                    
                    resultsDiv.innerHTML = `
                        <p class="success">Found ${activeRequests.length} active requests:</p>
                        ${activeRequests.map(request => `
                            <div class="request-card">
                                <strong>ID:</strong> ${request.id}<br>
                                <strong>Plot Size:</strong> ${request.plot_size}<br>
                                <strong>Budget:</strong> ${request.budget_range}<br>
                                <strong>Status:</strong> ${request.status}<br>
                                <strong>Requirements:</strong> ${request.requirements}
                            </div>
                        `).join('')}
                    `;
                } else {
                    resultsDiv.innerHTML = `<p class="error">✗ Failed to load requests: ${data.message}</p>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">✗ Network error: ${error.message}</p>`;
            }
        }

        async function deleteRequest() {
            const requestId = document.getElementById('deleteRequestId').value;
            const resultsDiv = document.getElementById('delete-results');
            
            if (!requestId) {
                resultsDiv.innerHTML = '<p class="error">✗ Please enter a request ID</p>';
                return;
            }
            
            try {
                resultsDiv.innerHTML = '<p class="info">Deleting request...</p>';
                
                const response = await fetch('/buildhub/backend/api/homeowner/delete_request.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        layout_request_id: parseInt(requestId)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultsDiv.innerHTML = `<p class="success">✓ Request ${requestId} deleted successfully</p>`;
                } else {
                    resultsDiv.innerHTML = `<p class="error">✗ Failed to delete request: ${data.message}</p>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">✗ Network error: ${error.message}</p>`;
            }
        }

        async function verifyDeletion() {
            const resultsDiv = document.getElementById('verify-results');
            
            try {
                resultsDiv.innerHTML = '<p class="info">Checking architect view...</p>';
                
                const response = await fetch('/buildhub/backend/api/architect/get_assigned_requests.php', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const assignments = data.assignments || [];
                    const deletedRequestId = document.getElementById('deleteRequestId').value;
                    
                    const stillVisible = assignments.find(a => a.layout_request.id == deletedRequestId);
                    
                    if (stillVisible) {
                        resultsDiv.innerHTML = `<p class="error">✗ Request ${deletedRequestId} is still visible to architect!</p>`;
                    } else {
                        resultsDiv.innerHTML = `<p class="success">✓ Request ${deletedRequestId} is no longer visible to architect</p>`;
                    }
                    
                    resultsDiv.innerHTML += `<p class="info">Architect currently sees ${assignments.length} assignments</p>`;
                } else {
                    resultsDiv.innerHTML = `<p class="error">✗ Failed to check architect view: ${data.message}</p>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">✗ Network error: ${error.message}</p>`;
            }
        }

        // Auto-load requests on page load
        window.onload = function() {
            listRequests();
        };
    </script>
</body>
</html>