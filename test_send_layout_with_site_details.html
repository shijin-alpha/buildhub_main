<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Send Layout with Site Details</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .error {
            color: #dc2626;
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success {
            color: #059669;
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .info {
            color: #0369a1;
            background: #f0f9ff;
            border: 1px solid #7dd3fc;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .data-display {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üöÄ Test Send Layout with Site Details</h1>
    
    <div class="info">
        <h3>Purpose</h3>
        <p>This test will manually send a layout to a contractor with complete site details to verify the enhanced data flow is working.</p>
    </div>
    
    <div class="test-section">
        <h2>1. Send Test Layout to Contractor</h2>
        <p>This will test the enhanced send_to_contractor.php API with site details:</p>
        
        <div class="form-group">
            <label>Contractor ID:</label>
            <input type="number" id="contractor_id" value="37" placeholder="Enter contractor ID">
        </div>
        
        <div class="form-group">
            <label>Homeowner ID:</label>
            <input type="number" id="homeowner_id" value="28" placeholder="Enter homeowner ID">
        </div>
        
        <div class="form-group">
            <label>Layout ID (optional):</label>
            <input type="number" id="layout_id" value="" placeholder="Enter layout ID or leave empty">
        </div>
        
        <div class="form-group">
            <label>Message:</label>
            <input type="text" id="message" value="Test layout with enhanced site details" placeholder="Enter message">
        </div>
        
        <button class="btn" onclick="sendTestLayout()">Send Test Layout</button>
        
        <div id="send-result"></div>
    </div>

    <div class="test-section">
        <h2>2. Verify Contractor Inbox</h2>
        <p>Check if the contractor received the layout with site details:</p>
        
        <button class="btn" onclick="checkContractorInbox()">Check Contractor Inbox</button>
        
        <div id="inbox-result"></div>
    </div>

    <div class="test-section">
        <h2>3. Test Estimation Form Data</h2>
        <p>Simulate opening the estimation form with the inbox data:</p>
        
        <button class="btn" onclick="testEstimationFormData()">Test Estimation Form Data</button>
        
        <div id="estimation-result"></div>
    </div>

    <script>
        // Mock session data
        const mockUser = {
            id: 28, // Homeowner ID
            first_name: 'Shijin',
            last_name: 'Thomas',
            email: 'shijin@example.com'
        };
        
        sessionStorage.setItem('user', JSON.stringify(mockUser));

        async function sendTestLayout() {
            const resultsDiv = document.getElementById('send-result');
            resultsDiv.innerHTML = '<p>Sending test layout...</p>';
            
            try {
                const contractorId = document.getElementById('contractor_id').value;
                const homeownerId = document.getElementById('homeowner_id').value;
                const layoutId = document.getElementById('layout_id').value;
                const message = document.getElementById('message').value;
                
                const requestBody = {
                    contractor_id: parseInt(contractorId),
                    homeowner_id: parseInt(homeownerId),
                    layout_id: layoutId ? parseInt(layoutId) : null,
                    message: message,
                    // Add some test site details
                    plot_size: '2500 sq ft',
                    building_size: '1800 sq ft'
                };
                
                console.log('Sending layout with data:', requestBody);
                
                const response = await fetch('/buildhub/backend/api/homeowner/send_to_contractor.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                console.log('Send layout result:', result);
                
                if (result.success) {
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Layout Sent Successfully!</h3>
                            <p><strong>Message:</strong> ${result.message}</p>
                            <p><strong>Contractor:</strong> ${result.contractor_name || 'Unknown'}</p>
                        </div>
                        
                        <h4>Request Data Sent:</h4>
                        <div class="data-display">${JSON.stringify(requestBody, null, 2)}</div>
                        
                        <h4>API Response:</h4>
                        <div class="data-display">${JSON.stringify(result, null, 2)}</div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Failed to Send Layout</h3>
                            <p><strong>Error:</strong> ${result.message}</p>
                            <div class="data-display">${JSON.stringify(result, null, 2)}</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Send layout error:', error);
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Network Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        async function checkContractorInbox() {
            const resultsDiv = document.getElementById('inbox-result');
            resultsDiv.innerHTML = '<p>Checking contractor inbox...</p>';
            
            try {
                const contractorId = document.getElementById('contractor_id').value;
                
                const response = await fetch(`/buildhub/backend/api/contractor/get_inbox.php?contractor_id=${contractorId}`, {
                    credentials: 'include'
                });
                
                const result = await response.json();
                console.log('Contractor inbox result:', result);
                
                if (result.success && result.items && result.items.length > 0) {
                    const latestItem = result.items[0];
                    
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Contractor Inbox Data Retrieved</h3>
                            <p><strong>Total Items:</strong> ${result.items.length}</p>
                            <p><strong>Latest Item ID:</strong> ${latestItem.id}</p>
                        </div>
                        
                        <h4>Latest Inbox Item Site Details:</h4>
                        <div class="data-display">
Plot Size: ${latestItem.plot_size || 'NOT SET'}
Building Size: ${latestItem.building_size || 'NOT SET'}
Budget Range: ${latestItem.budget_range || 'NOT SET'}
Timeline: ${latestItem.timeline || 'NOT SET'}
Number of Floors: ${latestItem.num_floors || 'NOT SET'}
Orientation: ${latestItem.orientation || 'NOT SET'}
Material Preferences: ${latestItem.material_preferences || 'NOT SET'}
Preferred Style: ${latestItem.preferred_style || 'NOT SET'}

Layout Request Details Available: ${latestItem.layout_request_details ? 'YES' : 'NO'}
                        </div>
                        
                        <h4>Full Latest Item Data:</h4>
                        <div class="data-display">${JSON.stringify(latestItem, null, 2)}</div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå No Contractor Inbox Items</h3>
                            <p>No items found in contractor inbox.</p>
                            <div class="data-display">${JSON.stringify(result, null, 2)}</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Contractor inbox error:', error);
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Network Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testEstimationFormData() {
            const resultsDiv = document.getElementById('estimation-result');
            resultsDiv.innerHTML = '<p>Testing estimation form data mapping...</p>';
            
            try {
                // First get the contractor inbox data
                const contractorId = document.getElementById('contractor_id').value;
                
                const response = await fetch(`/buildhub/backend/api/contractor/get_inbox.php?contractor_id=${contractorId}`, {
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success && result.items && result.items.length > 0) {
                    const inboxItem = result.items[0];
                    
                    // Simulate the EstimationForm data mapping
                    const payload = inboxItem.payload || {};
                    const layoutRequestDetails = inboxItem.layout_request_details || {};
                    const parsedRequirements = inboxItem.parsed_requirements || {};
                    
                    const formData = {
                        project_name: payload.plan_name || `Project for ${inboxItem.homeowner_name}`,
                        client_name: inboxItem.homeowner_name || '',
                        location: layoutRequestDetails.location || payload.location || '',
                        timeline: layoutRequestDetails.timeline || inboxItem.timeline || '90 days',
                        // Site details
                        plot_size: inboxItem.plot_size || layoutRequestDetails.plot_size || '',
                        building_size: inboxItem.building_size || layoutRequestDetails.building_size || '',
                        budget_range: inboxItem.budget_range || layoutRequestDetails.budget_range || '',
                        num_floors: inboxItem.num_floors || layoutRequestDetails.num_floors || '',
                        orientation: inboxItem.orientation || layoutRequestDetails.orientation || '',
                        site_considerations: inboxItem.site_considerations || layoutRequestDetails.site_considerations || '',
                        material_preferences: inboxItem.material_preferences || layoutRequestDetails.material_preferences || '',
                        budget_allocation: inboxItem.budget_allocation || layoutRequestDetails.budget_allocation || '',
                        preferred_style: inboxItem.preferred_style || layoutRequestDetails.preferred_style || '',
                        plot_shape: parsedRequirements.plot_shape || '',
                        topography: parsedRequirements.topography || '',
                        development_laws: parsedRequirements.development_laws || '',
                        family_needs: parsedRequirements.family_needs || '',
                        rooms: parsedRequirements.rooms || '',
                        aesthetic: parsedRequirements.aesthetic || ''
                    };
                    
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Estimation Form Data Mapping Test</h3>
                            <p>This shows how the data would appear in the estimation form:</p>
                        </div>
                        
                        <h4>üìã Basic Information Fields:</h4>
                        <div class="data-display">
Project Name: "${formData.project_name}"
Client Name: "${formData.client_name}"
Location: "${formData.location}"
Timeline: "${formData.timeline}"
Plot Size: "${formData.plot_size}" ${formData.plot_size ? '‚úÖ' : '‚ùå EMPTY'}
Building Size: "${formData.building_size}" ${formData.building_size ? '‚úÖ' : '‚ùå EMPTY'}
                        </div>
                        
                        <h4>üèóÔ∏è Site Details Fields:</h4>
                        <div class="data-display">
Budget Range: "${formData.budget_range}" ${formData.budget_range ? '‚úÖ' : '‚ùå EMPTY'}
Number of Floors: "${formData.num_floors}" ${formData.num_floors ? '‚úÖ' : '‚ùå EMPTY'}
Orientation: "${formData.orientation}" ${formData.orientation ? '‚úÖ' : '‚ùå EMPTY'}
Material Preferences: "${formData.material_preferences}" ${formData.material_preferences ? '‚úÖ' : '‚ùå EMPTY'}
Preferred Style: "${formData.preferred_style}" ${formData.preferred_style ? '‚úÖ' : '‚ùå EMPTY'}
Plot Shape: "${formData.plot_shape}" ${formData.plot_shape ? '‚úÖ' : '‚ùå EMPTY'}
Topography: "${formData.topography}" ${formData.topography ? '‚úÖ' : '‚ùå EMPTY'}
Family Needs: "${formData.family_needs}" ${formData.family_needs ? '‚úÖ' : '‚ùå EMPTY'}
Rooms: "${formData.rooms}" ${formData.rooms ? '‚úÖ' : '‚ùå EMPTY'}
Aesthetic: "${formData.aesthetic}" ${formData.aesthetic ? '‚úÖ' : '‚ùå EMPTY'}
                        </div>
                        
                        <h4>üìä Data Sources:</h4>
                        <div class="data-display">
Inbox Item Direct Fields: ${JSON.stringify({
    plot_size: inboxItem.plot_size,
    building_size: inboxItem.building_size,
    budget_range: inboxItem.budget_range,
    timeline: inboxItem.timeline
}, null, 2)}

Layout Request Details: ${JSON.stringify(layoutRequestDetails, null, 2)}

Parsed Requirements: ${JSON.stringify(parsedRequirements, null, 2)}
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå No Inbox Data Available</h3>
                            <p>Cannot test estimation form data without inbox items.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Estimation form test error:', error);
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Test Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>