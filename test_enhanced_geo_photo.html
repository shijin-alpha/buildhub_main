<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Geo Photo System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        .location-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
        }
        .coordinates {
            font-weight: bold;
            color: #28a745;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üåç Enhanced Geo Photo System Test</h1>
        <p>This test verifies the enhanced location accuracy and coordinate embedding features.</p>

        <div class="test-section info">
            <h3>üå¥ Kerala Location Validation</h3>
            <p><strong>For Kottayam District Users:</strong> This enhanced system specifically detects Kerala districts and should correctly identify your location as being in Kottayam District, Kerala instead of showing incorrect places like "Edathal".</p>
            <button onclick="testKeralaLocation()">Test Kerala District Detection</button>
            <div id="keralaResult"></div>
        </div>

        <!-- Location Test Section -->
        <div class="test-section info">
            <h3>üìç High-Accuracy GPS Location Test</h3>
            <p><strong>For Ponkunnam, Kottayam users:</strong> This test will force true GPS satellites instead of cell tower location to get your actual position.</p>
            <button onclick="testLocationAccuracy()">üõ∞Ô∏è Force GPS Satellites (30-60s)</button>
            <div id="locationResult"></div>
        </div>

        <!-- Camera Test Section -->
        <div class="test-section info">
            <h3>üì∏ Camera & Coordinate Embedding Test</h3>
            <p>Test camera access and coordinate overlay functionality.</p>
            <button onclick="testCameraAccess()">Test Camera Access</button>
            <button onclick="testCoordinateOverlay()" id="overlayBtn" disabled>Test Coordinate Overlay</button>
            <div id="cameraResult"></div>
            <video id="testVideo" style="width: 100%; max-width: 400px; display: none;" autoplay muted></video>
            <canvas id="testCanvas" style="display: none;"></canvas>
        </div>

        <!-- Browser Compatibility -->
        <div class="test-section info">
            <h3>üåê Browser Compatibility Check</h3>
            <div id="compatibilityResult"></div>
        </div>
    </div>

    <script>
        let currentLocation = null;
        let cameraStream = null;

        // Test Kerala location detection
        function testKeralaLocation() {
            const resultDiv = document.getElementById('keralaResult');
            
            // Test with known Kottayam coordinates
            const kottayamCoords = [
                { lat: 9.5916, lng: 76.5222, name: 'Kottayam Town Center' },
                { lat: 9.4981, lng: 76.5604, name: 'Changanassery' },
                { lat: 9.6747, lng: 76.6413, name: 'Pala' },
                { lat: 9.6186, lng: 76.4781, name: 'Ettumanoor' },
                { lat: 9.7489, lng: 76.3906, name: 'Vaikom' }
            ];
            
            let testResults = '<h4>üß™ Kerala District Detection Test Results:</h4>';
            
            kottayamCoords.forEach(coord => {
                const districtInfo = getKeralaDistrictInfo(coord.lat, coord.lng);
                const isCorrect = districtInfo && districtInfo.district === 'Kottayam';
                
                testResults += `
                    <div style="margin: 10px 0; padding: 10px; border-radius: 6px; background: ${isCorrect ? '#d4edda' : '#f8d7da'};">
                        <strong>${coord.name}</strong><br>
                        Coordinates: ${coord.lat.toFixed(4)}, ${coord.lng.toFixed(4)}<br>
                        Detected: ${districtInfo ? `${districtInfo.area}, ${districtInfo.district} District` : 'Not detected'}<br>
                        Status: ${isCorrect ? '‚úÖ Correct' : '‚ùå Incorrect'}
                    </div>
                `;
            });
            
            // Test current location if available
            if (currentLocation) {
                const currentDistrictInfo = getKeralaDistrictInfo(currentLocation.latitude, currentLocation.longitude);
                testResults += `
                    <div style="margin: 15px 0; padding: 15px; border-radius: 6px; background: #e7f3ff; border: 2px solid #007bff;">
                        <h5>üìç Your Current Location Analysis:</h5>
                        <strong>Coordinates:</strong> ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}<br>
                        <strong>Detected District:</strong> ${currentDistrictInfo ? `${currentDistrictInfo.district} District` : 'Not in Kerala or not detected'}<br>
                        <strong>Suggested Area:</strong> ${currentDistrictInfo ? currentDistrictInfo.area : 'Unknown'}<br>
                        <strong>Original Place Name:</strong> ${currentLocation.placeName}<br>
                        ${currentDistrictInfo ? '‚úÖ Kerala location detected' : '‚ö†Ô∏è Not detected as Kerala location'}
                    </div>
                `;
            }
            
            resultDiv.innerHTML = testResults;
        }

        // Test enhanced location accuracy
        async function testLocationAccuracy() {
            const resultDiv = document.getElementById('locationResult');
            resultDiv.innerHTML = '<p>üîÑ Getting your live location with high accuracy...</p>';

            if (!navigator.geolocation) {
                resultDiv.innerHTML = '<p class="error">‚ùå Geolocation not supported</p>';
                return;
            }

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    });
                });

                const { latitude, longitude, accuracy, altitude, heading, speed } = position.coords;
                
                // Get place name
                const placeName = await getPlaceName(latitude, longitude);
                
                currentLocation = {
                    latitude,
                    longitude,
                    accuracy,
                    altitude,
                    heading,
                    speed,
                    placeName,
                    timestamp: new Date().toISOString()
                };

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Location Captured Successfully!</h4>
                        <div class="location-display">
                            <div class="coordinates">üìç ${placeName}</div>
                            <div><strong>Latitude:</strong> ${latitude.toFixed(6)}¬∞</div>
                            <div><strong>Longitude:</strong> ${longitude.toFixed(6)}¬∞</div>
                            <div><strong>Accuracy:</strong> ¬±${Math.round(accuracy)}m</div>
                            ${altitude ? `<div><strong>Altitude:</strong> ${Math.round(altitude)}m</div>` : ''}
                            <div><strong>Captured:</strong> ${new Date().toLocaleString()}</div>
                        </div>
                    </div>
                `;

                // Enable overlay test
                document.getElementById('overlayBtn').disabled = false;

            } catch (error) {
                let errorMsg = 'Unknown error';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = 'Location access denied. Please allow location permissions.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = 'Location unavailable. Check your device settings.';
                        break;
                    case error.TIMEOUT:
                        errorMsg = 'Location request timed out. Try again.';
                        break;
                }
                
                resultDiv.innerHTML = `<div class="error">‚ùå ${errorMsg}</div>`;
            }
        }

        // Get place name using enhanced Kerala-aware reverse geocoding
        async function getPlaceName(latitude, longitude) {
            try {
                // Check if coordinates are in Kerala bounds
                const isInKerala = (lat, lng) => {
                    return lat >= 8.2 && lat <= 12.8 && lng >= 74.8 && lng <= 77.4;
                };
                
                const isKeralaLocation = isInKerala(latitude, longitude);
                
                // Try multiple geocoding services for better accuracy
                let bestResult = null;
                
                // Service 1: OpenStreetMap Nominatim with Kerala-specific parameters
                try {
                    const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=16&addressdetails=1&accept-language=en&countrycodes=in`;
                    
                    const nominatimResponse = await fetch(nominatimUrl, {
                        headers: {
                            'User-Agent': 'BuildHub-GeoPhoto-Test/1.0 (Kerala Location Service)'
                        }
                    });
                    
                    if (nominatimResponse.ok) {
                        const data = await nominatimResponse.json();
                        
                        if (data && data.address) {
                            const address = data.address;
                            
                            // Kerala-specific address parsing
                            if (isKeralaLocation) {
                                bestResult = parseKeralaAddress(address, latitude, longitude);
                            }
                            
                            // Fallback to general parsing if Kerala-specific failed
                            if (!bestResult) {
                                bestResult = parseGeneralAddress(address);
                            }
                        }
                    }
                } catch (nominatimError) {
                    console.log('Nominatim geocoding failed:', nominatimError);
                }
                
                // Service 2: Try alternative geocoding if first failed or result seems wrong
                if (!bestResult || bestResult.includes('Edathal') || bestResult.length < 10) {
                    try {
                        // Use a different zoom level for more accurate results
                        const altUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=14&addressdetails=1&accept-language=en&countrycodes=in&extratags=1`;
                        
                        const altResponse = await fetch(altUrl, {
                            headers: {
                                'User-Agent': 'BuildHub-GeoPhoto-Alt/1.0'
                            }
                        });
                        
                        if (altResponse.ok) {
                            const altData = await altResponse.json();
                            if (altData && altData.address) {
                                const altAddress = isKeralaLocation ? 
                                    parseKeralaAddress(altData.address, latitude, longitude) : 
                                    parseGeneralAddress(altData.address);
                                
                                if (altAddress && altAddress !== bestResult) {
                                    bestResult = altAddress;
                                }
                            }
                        }
                    } catch (altError) {
                        console.log('Alternative geocoding failed:', altError);
                    }
                }
                
                // Service 3: Kerala district-specific validation
                if (isKeralaLocation) {
                    const districtInfo = getKeralaDistrictInfo(latitude, longitude);
                    if (districtInfo && bestResult) {
                        // Validate if the result matches the expected district
                        if (!bestResult.toLowerCase().includes(districtInfo.district.toLowerCase())) {
                            bestResult = `${bestResult}, ${districtInfo.district} District, Kerala`;
                        }
                    } else if (districtInfo) {
                        bestResult = `${districtInfo.area}, ${districtInfo.district} District, Kerala`;
                    }
                }
                
                // Final validation and formatting
                if (bestResult) {
                    // Clean up the result
                    bestResult = cleanLocationName(bestResult);
                    
                    // Ensure it's not too long
                    if (bestResult.length > 80) {
                        bestResult = bestResult.substring(0, 77) + '...';
                    }
                    
                    return bestResult;
                }
                
                // Ultimate fallback with district estimation
                if (isKeralaLocation) {
                    const districtInfo = getKeralaDistrictInfo(latitude, longitude);
                    if (districtInfo) {
                        return `${districtInfo.area}, ${districtInfo.district} District, Kerala`;
                    }
                }
                
                return `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                
            } catch (error) {
                console.error('All geocoding services failed:', error);
                return `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
            }
        }

        // Kerala-specific address parsing
        function parseKeralaAddress(address, lat, lng) {
            const components = [];
            
            // Road/Street
            if (address.road) {
                components.push(address.road);
            }
            
            // Village/Town/City (prioritize local names)
            const locality = address.village || address.town || address.city || 
                            address.municipality || address.suburb || address.neighbourhood;
            if (locality) {
                components.push(locality);
            }
            
            // Taluk/Block
            if (address.county || address.state_district) {
                components.push(address.county || address.state_district);
            }
            
            // District (ensure it's correct for Kerala)
            let district = address.state_district || address.county;
            if (!district || !district.toLowerCase().includes('district')) {
                // Try to determine district from coordinates
                const districtInfo = getKeralaDistrictInfo(lat, lng);
                if (districtInfo) {
                    district = districtInfo.district + ' District';
                }
            }
            
            if (district) {
                components.push(district);
            }
            
            // State
            if (address.state && address.state.toLowerCase().includes('kerala')) {
                components.push('Kerala');
            }
            
            return components.length > 0 ? components.join(', ') : null;
        }

        // General address parsing for non-Kerala locations
        function parseGeneralAddress(address) {
            const components = [];
            
            if (address.house_number && address.road) {
                components.push(`${address.house_number} ${address.road}`);
            } else if (address.road) {
                components.push(address.road);
            }
            
            if (address.neighbourhood || address.suburb || address.residential) {
                components.push(address.neighbourhood || address.suburb || address.residential);
            }
            
            if (address.city || address.town || address.village || address.municipality) {
                components.push(address.city || address.town || address.village || address.municipality);
            }
            
            if (address.state) {
                components.push(address.state);
            }
            
            return components.length > 0 ? components.join(', ') : null;
        }

        // Kerala district information based on coordinates
        function getKeralaDistrictInfo(lat, lng) {
            // Kerala districts with approximate coordinate bounds
            const keralaDistricts = [
                {
                    district: 'Kottayam',
                    bounds: { minLat: 9.4, maxLat: 9.9, minLng: 76.3, maxLng: 76.8 },
                    areas: ['Kottayam Town', 'Changanassery', 'Pala', 'Ettumanoor', 'Vaikom']
                },
                {
                    district: 'Ernakulam',
                    bounds: { minLat: 9.8, maxLat: 10.3, minLng: 76.0, maxLng: 76.8 },
                    areas: ['Kochi', 'Ernakulam', 'Aluva', 'Perumbavoor', 'Muvattupuzha']
                },
                {
                    district: 'Thiruvananthapuram',
                    bounds: { minLat: 8.2, maxLat: 8.9, minLng: 76.8, maxLng: 77.4 },
                    areas: ['Thiruvananthapuram', 'Neyyattinkara', 'Attingal', 'Varkala']
                },
                {
                    district: 'Kollam',
                    bounds: { minLat: 8.7, maxLat: 9.2, minLng: 76.4, maxLng: 77.0 },
                    areas: ['Kollam', 'Karunagappally', 'Punalur', 'Paravur']
                },
                {
                    district: 'Pathanamthitta',
                    bounds: { minLat: 9.1, maxLat: 9.7, minLng: 76.6, maxLng: 77.2 },
                    areas: ['Pathanamthitta', 'Adoor', 'Thiruvalla', 'Mallappally']
                },
                {
                    district: 'Alappuzha',
                    bounds: { minLat: 9.4, maxLat: 9.9, minLng: 76.2, maxLng: 76.7 },
                    areas: ['Alappuzha', 'Cherthala', 'Kayamkulam', 'Mavelikkara']
                },
                {
                    district: 'Idukki',
                    bounds: { minLat: 9.2, maxLat: 10.3, minLng: 76.7, maxLng: 77.5 },
                    areas: ['Thodupuzha', 'Munnar', 'Devikulam', 'Udumbanchola']
                },
                {
                    district: 'Thrissur',
                    bounds: { minLat: 10.2, maxLat: 10.8, minLng: 75.9, maxLng: 76.8 },
                    areas: ['Thrissur', 'Chalakudy', 'Kodungallur', 'Irinjalakuda']
                },
                {
                    district: 'Palakkad',
                    bounds: { minLat: 10.4, maxLat: 11.2, minLng: 76.2, maxLng: 77.0 },
                    areas: ['Palakkad', 'Ottappalam', 'Chittur', 'Mannarkkad']
                },
                {
                    district: 'Malappuram',
                    bounds: { minLat: 10.9, maxLat: 11.5, minLng: 75.8, maxLng: 76.4 },
                    areas: ['Malappuram', 'Manjeri', 'Perinthalmanna', 'Tirur']
                },
                {
                    district: 'Kozhikode',
                    bounds: { minLat: 11.0, maxLat: 11.6, minLng: 75.5, maxLng: 76.2 },
                    areas: ['Kozhikode', 'Vadakara', 'Koyilandy', 'Feroke']
                },
                {
                    district: 'Wayanad',
                    bounds: { minLat: 11.6, maxLat: 12.0, minLng: 75.8, maxLng: 76.5 },
                    areas: ['Kalpetta', 'Mananthavady', 'Sulthan Bathery']
                },
                {
                    district: 'Kannur',
                    bounds: { minLat: 11.8, maxLat: 12.4, minLng: 75.0, maxLng: 75.8 },
                    areas: ['Kannur', 'Thalassery', 'Payyanur', 'Iritty']
                },
                {
                    district: 'Kasaragod',
                    bounds: { minLat: 12.0, maxLat: 12.8, minLng: 74.8, maxLng: 75.4 },
                    areas: ['Kasaragod', 'Kanhangad', 'Nileshwar', 'Uppala']
                }
            ];
            
            for (const districtData of keralaDistricts) {
                const bounds = districtData.bounds;
                if (lat >= bounds.minLat && lat <= bounds.maxLat && 
                    lng >= bounds.minLng && lng <= bounds.maxLng) {
                    
                    // Find closest area within the district
                    let closestArea = districtData.areas[0]; // Default to first area
                    
                    return {
                        district: districtData.district,
                        area: closestArea
                    };
                }
            }
            
            return null;
        }

        // Clean up location names
        function cleanLocationName(locationName) {
            return locationName
                .replace(/,\s*,/g, ',') // Remove double commas
                .replace(/^,\s*/, '') // Remove leading comma
                .replace(/,\s*$/, '') // Remove trailing comma
                .replace(/\s+/g, ' ') // Replace multiple spaces with single space
                .trim();
        }

        // Test camera access
        async function testCameraAccess() {
            const resultDiv = document.getElementById('cameraResult');
            const video = document.getElementById('testVideo');

            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });

                video.srcObject = cameraStream;
                video.style.display = 'block';
                
                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ Camera access successful! Video stream active.
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Camera access failed: ${error.message}
                    </div>
                `;
            }
        }

        // Test coordinate overlay
        function testCoordinateOverlay() {
            if (!currentLocation) {
                alert('Please get location first!');
                return;
            }

            const video = document.getElementById('testVideo');
            const canvas = document.getElementById('testCanvas');
            const context = canvas.getContext('2d');

            if (!video.videoWidth) {
                alert('Please start camera first!');
                return;
            }

            // Set canvas size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Add enhanced location overlay
            addLocationOverlay(context, canvas.width, canvas.height);

            // Show result
            canvas.style.display = 'block';
            canvas.style.maxWidth = '100%';
            canvas.style.border = '2px solid #28a745';
            canvas.style.borderRadius = '8px';
            canvas.style.marginTop = '10px';

            document.getElementById('cameraResult').innerHTML += `
                <div class="success" style="margin-top: 10px;">
                    ‚úÖ Coordinate overlay added successfully! Check the image below with embedded GPS coordinates.
                </div>
            `;
        }

        // Enhanced location overlay function
        function addLocationOverlay(context, width, height) {
            const overlayHeight = 140;
            
            // Semi-transparent dark overlay
            context.fillStyle = 'rgba(0, 0, 0, 0.8)';
            context.fillRect(0, height - overlayHeight, width, overlayHeight);
            
            // Border
            context.fillStyle = 'rgba(255, 255, 255, 0.3)';
            context.fillRect(0, height - overlayHeight, width, 2);

            // White text
            context.fillStyle = 'white';
            context.textAlign = 'left';
            
            const padding = 20;
            let yPos = height - overlayHeight + 25;
            
            // Place name
            context.font = 'bold 18px Arial';
            context.fillText(`üìç ${currentLocation.placeName}`, padding, yPos);
            yPos += 28;
            
            // Coordinates (prominent)
            context.font = 'bold 16px Arial';
            context.fillStyle = '#FFD700'; // Gold
            context.fillText(`Lat: ${currentLocation.latitude.toFixed(6)}¬∞`, padding, yPos);
            context.fillText(`Lng: ${currentLocation.longitude.toFixed(6)}¬∞`, padding + 180, yPos);
            yPos += 22;
            
            // Timestamp
            context.font = '14px Arial';
            context.fillStyle = 'white';
            const timestamp = new Date().toLocaleString();
            context.fillText(`üïí ${timestamp}`, padding, yPos);
            yPos += 20;
            
            // Accuracy
            context.font = '13px Arial';
            context.fillStyle = '#90EE90';
            context.fillText(`üì° GPS Accuracy: ¬±${Math.round(currentLocation.accuracy)}m`, padding, yPos);
            
            // Watermark
            context.font = '12px Arial';
            context.fillStyle = 'rgba(255, 255, 255, 0.7)';
            context.textAlign = 'right';
            context.fillText('BuildHub Geo Photo Test', width - padding, height - 10);
        }

        // Check browser compatibility
        function checkCompatibility() {
            const resultDiv = document.getElementById('compatibilityResult');
            const features = [];

            // Check required features
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                features.push('‚úÖ Camera Access (getUserMedia)');
            } else {
                features.push('‚ùå Camera Access (getUserMedia) - Not supported');
            }

            if (navigator.geolocation) {
                features.push('‚úÖ Geolocation API');
            } else {
                features.push('‚ùå Geolocation API - Not supported');
            }

            if (window.File && window.FileReader && window.FormData) {
                features.push('‚úÖ File API');
            } else {
                features.push('‚ùå File API - Not supported');
            }

            if (document.createElement('canvas').getContext) {
                features.push('‚úÖ Canvas API');
            } else {
                features.push('‚ùå Canvas API - Not supported');
            }

            if (window.fetch) {
                features.push('‚úÖ Fetch API');
            } else {
                features.push('‚ùå Fetch API - Not supported');
            }

            resultDiv.innerHTML = `
                <h4>Browser Feature Support:</h4>
                <ul>
                    ${features.map(feature => `<li>${feature}</li>`).join('')}
                </ul>
                <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                <p><strong>Platform:</strong> ${navigator.platform}</p>
                <p><strong>Language:</strong> ${navigator.language}</p>
            `;
        }

        // Initialize compatibility check on load
        window.onload = function() {
            checkCompatibility();
        };

        // Cleanup on page unload
        window.onbeforeunload = function() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        };
    </script>
</body>
</html>