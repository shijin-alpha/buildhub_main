<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Contractor Estimation Form Site Details</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .success {
            color: #059669;
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .error {
            color: #dc2626;
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .info {
            color: #0369a1;
            background: #f0f9ff;
            border: 1px solid #7dd3fc;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .warning {
            color: #d97706;
            background: #fffbeb;
            border: 1px solid #fed7aa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .data-display {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .site-details-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .detail-group {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
        }
        .detail-group h4 {
            margin: 0 0 10px 0;
            color: #1e293b;
            font-size: 16px;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-row label {
            font-weight: 500;
            color: #475569;
        }
        .detail-row span {
            color: #1e293b;
            text-align: right;
        }
        .detail-row span.empty {
            color: #dc2626;
            font-style: italic;
        }
        .detail-row span.has-data {
            color: #059669;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üéØ Test Contractor Estimation Form Site Details</h1>
    
    <div class="info">
        <h3>Test Overview</h3>
        <p>This test verifies that the contractor estimation form displays site details correctly in the dedicated "Site & Project Details" section.</p>
        <ul>
            <li>‚úÖ Get contractor inbox data with site details</li>
            <li>‚úÖ Simulate EstimationForm data initialization</li>
            <li>‚úÖ Preview how Site Details section would appear</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>1. Get Contractor Inbox with Site Details</h2>
        <p>Fetch the latest inbox item with comprehensive site details:</p>
        
        <button class="btn" onclick="getContractorInboxData()">Get Contractor Inbox Data</button>
        
        <div id="inbox-data-result"></div>
    </div>

    <div class="test-section">
        <h2>2. Preview Site Details Section</h2>
        <p>Show how the Site Details section would appear in the estimation form:</p>
        
        <button class="btn" onclick="previewSiteDetailsSection()">Preview Site Details Section</button>
        
        <div id="site-details-preview-result"></div>
    </div>

    <div class="test-section">
        <h2>3. Instructions for Contractor</h2>
        <div class="warning">
            <h3>üìã How to Access Site Details in Contractor Dashboard:</h3>
            <ol>
                <li><strong>Go to Contractor Dashboard:</strong> Login as contractor (ID: 37)</li>
                <li><strong>Check Inbox:</strong> Look for layout requests from homeowners</li>
                <li><strong>Open Estimation Form:</strong> Click "Create Estimate" for any inbox item</li>
                <li><strong>Navigate to Site Details:</strong> Look for the navigation menu on the left side</li>
                <li><strong>Click "üèóÔ∏è Site Details":</strong> This will scroll to the Site & Project Details section</li>
                <li><strong>View Organized Data:</strong> Site details are organized in 4 groups:
                    <ul>
                        <li>üìê Site Specifications (Plot Size, Building Size, Floors)</li>
                        <li>üí∞ Budget & Timeline (Budget Range, Timeline)</li>
                        <li>üé® Design Preferences (Style, Materials)</li>
                        <li>üè† Requirements (Family Needs, Rooms)</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <script>
        let inboxData = null;

        async function getContractorInboxData() {
            const resultsDiv = document.getElementById('inbox-data-result');
            resultsDiv.innerHTML = '<p>Fetching contractor inbox data...</p>';
            
            try {
                const response = await fetch('/buildhub/backend/api/contractor/get_inbox.php?contractor_id=37', {
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success && result.items && result.items.length > 0) {
                    // Find item with site details
                    const itemWithSiteDetails = result.items.find(item => 
                        item.layout_request_details && 
                        (item.plot_size || item.layout_request_details.plot_size)
                    );
                    
                    if (itemWithSiteDetails) {
                        inboxData = itemWithSiteDetails;
                        
                        let resultsHTML = `
                            <div class="success">
                                <h3>‚úÖ Found Inbox Item with Site Details</h3>
                                <p><strong>Item ID:</strong> ${itemWithSiteDetails.id}</p>
                                <p><strong>Homeowner:</strong> ${itemWithSiteDetails.homeowner_name}</p>
                                <p><strong>Message:</strong> ${itemWithSiteDetails.message || 'No message'}</p>
                            </div>
                            
                            <h4>üìä Available Site Data:</h4>
                            <div class="data-display">
Direct Fields:
- plot_size: ${itemWithSiteDetails.plot_size || 'NOT SET'}
- building_size: ${itemWithSiteDetails.building_size || 'NOT SET'}
- budget_range: ${itemWithSiteDetails.budget_range || 'NOT SET'}
- timeline: ${itemWithSiteDetails.timeline || 'NOT SET'}

Layout Request Details:
${itemWithSiteDetails.layout_request_details ? JSON.stringify(itemWithSiteDetails.layout_request_details, null, 2) : 'NOT SET'}

Parsed Requirements:
${itemWithSiteDetails.parsed_requirements ? JSON.stringify(itemWithSiteDetails.parsed_requirements, null, 2) : 'NOT SET'}
                            </div>
                        `;
                        
                        resultsDiv.innerHTML = resultsHTML;
                    } else {
                        resultsDiv.innerHTML = `
                            <div class="error">
                                <h3>‚ùå No Site Details Found</h3>
                                <p>Found ${result.items.length} inbox items, but none have layout_request_details with site data.</p>
                                <p>Please run the test data creation script first:</p>
                                <code>php create_test_data_simple.php</code>
                            </div>
                        `;
                    }
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå No Inbox Items</h3>
                            <p>No contractor inbox items found. Error: ${result.message || 'Unknown error'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Inbox data fetch error:', error);
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Fetch Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        async function previewSiteDetailsSection() {
            const resultsDiv = document.getElementById('site-details-preview-result');
            
            if (!inboxData) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå No Data Available</h3>
                        <p>Please run "Get Contractor Inbox Data" first.</p>
                    </div>
                `;
                return;
            }
            
            resultsDiv.innerHTML = '<p>Generating site details preview...</p>';
            
            try {
                // Simulate EstimationForm data mapping
                const inboxItem = inboxData;
                const payload = inboxItem.payload || {};
                const layoutRequestDetails = inboxItem.layout_request_details || {};
                const parsedRequirements = inboxItem.parsed_requirements || {};
                
                const formData = {
                    plot_size: inboxItem.plot_size || layoutRequestDetails.plot_size || '',
                    building_size: inboxItem.building_size || layoutRequestDetails.building_size || '',
                    budget_range: inboxItem.budget_range || layoutRequestDetails.budget_range || '',
                    timeline: layoutRequestDetails.timeline || inboxItem.timeline || '90 days',
                    num_floors: inboxItem.num_floors || layoutRequestDetails.num_floors || '',
                    orientation: inboxItem.orientation || layoutRequestDetails.orientation || '',
                    site_considerations: inboxItem.site_considerations || layoutRequestDetails.site_considerations || '',
                    material_preferences: inboxItem.material_preferences || layoutRequestDetails.material_preferences || '',
                    budget_allocation: inboxItem.budget_allocation || layoutRequestDetails.budget_allocation || '',
                    preferred_style: inboxItem.preferred_style || layoutRequestDetails.preferred_style || '',
                    plot_shape: parsedRequirements.plot_shape || '',
                    topography: parsedRequirements.topography || '',
                    development_laws: parsedRequirements.development_laws || '',
                    family_needs: parsedRequirements.family_needs || '',
                    rooms: parsedRequirements.rooms || '',
                    aesthetic: parsedRequirements.aesthetic || ''
                };
                
                let resultsHTML = `
                    <div class="success">
                        <h3>‚úÖ Site Details Section Preview</h3>
                        <p>This is exactly how the Site Details section would appear in the contractor estimation form:</p>
                    </div>
                    
                    <div class="site-details-preview">
                        <div class="detail-group">
                            <h4>üìê Site Specifications</h4>
                `;
                
                const siteSpecs = [
                    ['Plot Size', formData.plot_size],
                    ['Building Size', formData.building_size],
                    ['Number of Floors', formData.num_floors],
                    ['Plot Shape', formData.plot_shape],
                    ['Topography', formData.topography],
                    ['Orientation', formData.orientation]
                ];
                
                siteSpecs.forEach(([label, value]) => {
                    const hasValue = value && value !== '';
                    resultsHTML += `
                        <div class="detail-row">
                            <label>${label}:</label>
                            <span class="${hasValue ? 'has-data' : 'empty'}">${hasValue ? value : 'Not specified'}</span>
                        </div>
                    `;
                });
                
                resultsHTML += `
                        </div>
                        <div class="detail-group">
                            <h4>üí∞ Budget & Timeline</h4>
                `;
                
                const budgetTimeline = [
                    ['Budget Range', formData.budget_range],
                    ['Budget Allocation', formData.budget_allocation],
                    ['Timeline', formData.timeline]
                ];
                
                budgetTimeline.forEach(([label, value]) => {
                    const hasValue = value && value !== '';
                    resultsHTML += `
                        <div class="detail-row">
                            <label>${label}:</label>
                            <span class="${hasValue ? 'has-data' : 'empty'}">${hasValue ? value : 'Not specified'}</span>
                        </div>
                    `;
                });
                
                resultsHTML += `
                        </div>
                        <div class="detail-group">
                            <h4>üé® Design Preferences</h4>
                `;
                
                const designPrefs = [
                    ['Preferred Style', formData.preferred_style],
                    ['Aesthetic', formData.aesthetic],
                    ['Material Preferences', formData.material_preferences]
                ];
                
                designPrefs.forEach(([label, value]) => {
                    const hasValue = value && value !== '';
                    resultsHTML += `
                        <div class="detail-row">
                            <label>${label}:</label>
                            <span class="${hasValue ? 'has-data' : 'empty'}">${hasValue ? value : 'Not specified'}</span>
                        </div>
                    `;
                });
                
                resultsHTML += `
                        </div>
                        <div class="detail-group">
                            <h4>üè† Requirements</h4>
                `;
                
                const requirements = [
                    ['Family Needs', formData.family_needs],
                    ['Rooms', formData.rooms],
                    ['Development Laws', formData.development_laws]
                ];
                
                requirements.forEach(([label, value]) => {
                    const hasValue = value && value !== '';
                    resultsHTML += `
                        <div class="detail-row">
                            <label>${label}:</label>
                            <span class="${hasValue ? 'has-data' : 'empty'}">${hasValue ? value : 'Not specified'}</span>
                        </div>
                    `;
                });
                
                resultsHTML += `
                        </div>
                    </div>
                    
                    <div class="info">
                        <h4>üéØ What You Should See in Contractor Dashboard:</h4>
                        <ul>
                            <li><strong>Navigation Menu:</strong> Left sidebar with "üèóÔ∏è Site Details" button</li>
                            <li><strong>Site Details Section:</strong> Organized in 4 groups as shown above</li>
                            <li><strong>Auto-populated Data:</strong> Values should appear automatically from homeowner's layout request</li>
                            <li><strong>Basic Information:</strong> Plot Size and Building Size also appear in the Basic Info section</li>
                        </ul>
                    </div>
                `;
                
                resultsDiv.innerHTML = resultsHTML;
                
            } catch (error) {
                console.error('Preview generation error:', error);
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Preview Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        // Auto-run the first test on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Contractor estimation form site details test loaded');
            setTimeout(() => {
                getContractorInboxData();
            }, 1000);
        });
    </script>
</body>
</html>