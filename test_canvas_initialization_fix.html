<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Initialization Fix Test</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .canvas-container {
            width: 100%;
            height: 400px;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #fafafa;
            margin: 20px 0;
            position: relative;
        }
        
        .test-canvas {
            border: 1px solid #999;
            background: white;
            border-radius: 4px;
        }
        
        .resize-controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #f0f0f0;
            border-color: #999;
        }
        
        .canvas-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Canvas Initialization Fix Test</h1>
        <p>This test simulates the React component initialization order to verify the fix works correctly.</p>
        
        <div id="status" class="status info">Initializing...</div>
        
        <div class="resize-controls">
            <button onclick="resizeContainer(600, 300)">Small (600×300)</button>
            <button onclick="resizeContainer(800, 400)">Medium (800×400)</button>
            <button onclick="resizeContainer(1000, 500)">Large (1000×500)</button>
            <button onclick="testReinitialization()">Test Reinitialization</button>
        </div>
        
        <div class="canvas-container" id="canvasContainer">
            <div class="canvas-info" id="canvasInfo">Canvas: Not initialized</div>
            <canvas id="testCanvas" class="test-canvas"></canvas>
        </div>
        
        <div id="log" style="background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
    </div>

    <script>
        let canvas, ctx;
        let planData = {
            plot_width: 40,
            plot_height: 30,
            rooms: [
                { x: 50, y: 50, layout_width: 10, layout_height: 8, name: 'Living Room', color: '#e3f2fd' },
                { x: 200, y: 50, layout_width: 8, layout_height: 6, name: 'Kitchen', color: '#f3e5f5' },
                { x: 50, y: 200, layout_width: 12, layout_height: 10, name: 'Master Bedroom', color: '#e8f5e8' }
            ]
        };
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        // Simulate the React component initialization order
        function initializeCanvas() {
            try {
                log('Starting canvas initialization...');
                
                // Step 1: Get canvas element (simulating useRef)
                canvas = document.getElementById('testCanvas');
                if (!canvas) {
                    throw new Error('Canvas element not found');
                }
                
                // Step 2: Get container (simulating parent element access)
                const container = canvas.parentElement;
                if (!container) {
                    throw new Error('Canvas container not found');
                }
                
                // Step 3: Calculate dimensions (simulating the useEffect logic)
                const containerWidth = container.clientWidth - 32; // Account for padding
                const containerHeight = container.clientHeight - 32;
                
                log(`Container dimensions: ${containerWidth}×${containerHeight}`);
                
                // Step 4: Calculate optimal canvas size
                const maxWidth = Math.min(containerWidth, 1200);
                const maxHeight = Math.min(containerHeight, 800);
                
                log(`Calculated canvas size: ${maxWidth}×${maxHeight}`);
                
                // Step 5: Set canvas dimensions
                canvas.width = maxWidth;
                canvas.height = maxHeight;
                
                // Step 6: Get context (simulating setCanvas)
                ctx = canvas.getContext('2d');
                if (!ctx) {
                    throw new Error('Failed to get canvas context');
                }
                
                log('Canvas context obtained successfully');
                
                // Step 7: Call drawCanvas (this is where the error was occurring)
                drawCanvas();
                
                updateStatus('Canvas initialized successfully!', 'success');
                log('Canvas initialization completed successfully');
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
                log(`ERROR: ${error.message}`);
                console.error('Canvas initialization failed:', error);
            }
        }
        
        // Simulate the drawCanvas function (defined before useEffect in the fix)
        function drawCanvas() {
            if (!ctx || !canvas) {
                throw new Error('Canvas or context not available in drawCanvas');
            }
            
            log('Drawing canvas content...');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            drawGrid();
            
            // Draw plot boundary
            drawPlotBoundary();
            
            // Draw rooms
            planData.rooms.forEach((room, index) => {
                drawRoom(room, false);
            });
            
            // Update info display
            document.getElementById('canvasInfo').textContent = 
                `Canvas: ${canvas.width}×${canvas.height}`;
            
            log('Canvas drawing completed');
        }
        
        function drawGrid() {
            ctx.strokeStyle = '#e8e8e8';
            ctx.lineWidth = 0.5;
            
            const gridSize = 20;
            
            // Vertical lines
            for (let x = 0; x <= canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // Horizontal lines
            for (let y = 0; y <= canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }
        
        function drawPlotBoundary() {
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 3;
            
            const plotPixelWidth = planData.plot_width * 20;
            const plotPixelHeight = planData.plot_height * 20;
            
            ctx.strokeRect(20, 20, plotPixelWidth, plotPixelHeight);
            
            // Add plot dimensions
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${planData.plot_width}'`, 20 + plotPixelWidth / 2, 15);
        }
        
        function drawRoom(room, isSelected) {
            const x = room.x + 20;
            const y = room.y + 20;
            const width = room.layout_width * 20;
            const height = room.layout_height * 20;
            
            // Room background
            ctx.fillStyle = room.color || '#e3f2fd';
            ctx.fillRect(x, y, width, height);
            
            // Room border
            ctx.strokeStyle = isSelected ? '#1976d2' : '#666';
            ctx.lineWidth = isSelected ? 3 : 1;
            ctx.strokeRect(x, y, width, height);
            
            // Room label
            ctx.fillStyle = '#333';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(room.name, x + width / 2, y + height / 2);
        }
        
        function resizeContainer(width, height) {
            const container = document.getElementById('canvasContainer');
            container.style.width = width + 'px';
            container.style.height = height + 'px';
            
            log(`Container resized to ${width}×${height}`);
            
            // Simulate window resize event
            setTimeout(() => {
                if (canvas && ctx) {
                    initializeCanvas();
                }
            }, 100);
        }
        
        function testReinitialization() {
            log('Testing reinitialization...');
            updateStatus('Reinitializing...', 'info');
            
            // Reset canvas
            canvas = null;
            ctx = null;
            
            // Reinitialize after a short delay
            setTimeout(initializeCanvas, 100);
        }
        
        // Initialize when page loads
        window.addEventListener('load', () => {
            log('Page loaded, starting initialization test');
            initializeCanvas();
        });
        
        // Test resize handling
        window.addEventListener('resize', () => {
            if (canvas && ctx) {
                log('Window resized, updating canvas');
                initializeCanvas();
            }
        });
    </script>
</body>
</html>